---
// PartnersMarquee.astro
// Clean horizontal scrolling partner logos with pause on hover
---

<section class="partners-marquee bg-ivory py-20 md:py-28 overflow-hidden">
  <div class="container mx-auto px-4 md:px-6">
    <!-- Section Header -->
    <div class="text-center mb-12 md:mb-16">
      <p class="text-sm uppercase tracking-widest text-charcoal/60 mb-3 font-inter">
        Our Partners
      </p>
      <h2 class="text-4xl md:text-5xl font-playfair text-charcoal mb-4">
        Organizations We Collaborate With
      </h2>
      <p class="text-lg text-charcoal/70 font-inter max-w-2xl mx-auto">
        Building meaningful partnerships to enrich cultural education
      </p>
    </div>

    <!-- Marquee Container -->
    <div class="marquee-wrapper relative" data-marquee-wrapper>
      <div class="marquee-track flex items-center gap-16 md:gap-20" data-marquee-track>
        <!-- First Set of Logos -->
        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/GEF-Logo.jpg" 
            alt="GEF partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/Gandharva.png" 
            alt="Gandharva partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/dharmyog.png" 
            alt="Dharmyog partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/PSS-logo.png" 
            alt="PSS partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/reform.png" 
            alt="Reform partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <!-- Duplicate Set for Seamless Loop -->
        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/GEF-Logo.jpg" 
            alt="GEF partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/Gandharva.png" 
            alt="Gandharva partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/dharmyog.png" 
            alt="Dharmyog partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/PSS-logo.png" 
            alt="PSS partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/reform.png" 
            alt="Reform partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>
      </div>
    </div>

  </div>
</section>

<script>
  import { gsap } from 'gsap';

  // Wait for DOM to be ready
  if (typeof window !== 'undefined') {
    const initMarquee = (isRetry = false) => {
      // Check for reduced motion preference
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      if (!prefersReducedMotion) {
        const marqueeWrapper = document.querySelector('[data-marquee-wrapper]') as HTMLElement;
        const marqueeTrack = document.querySelector('[data-marquee-track]') as HTMLElement;

        if (!marqueeWrapper || !marqueeTrack) {
          return;
        }

        // Calculate the width of one complete set of logos (5 logos)
        const logos = marqueeTrack.querySelectorAll('.logo-item');
        
        if (logos.length === 0) {
          // Only warn and retry once if this is the first attempt
          if (!isRetry) {
            // Retry after a short delay to allow Astro hydration to complete
            setTimeout(() => {
              initMarquee(true);
            }, 300);
          } else if (import.meta.env.DEV) {
            console.warn('No logo items found in marquee track. Marquee animation disabled.');
          }
          return;
        }
        
        // Wait for images to load to get accurate width
        const images = marqueeTrack.querySelectorAll('img');
        let loadedCount = 0;
        let animationInitialized = false;
        
        const initAnimation = () => {
          // Prevent multiple initializations
          if (animationInitialized) return;
          
          // Verify we have at least 5 logos (one complete set)
          if (logos.length < 5) {
            console.warn('Not enough logo items found for marquee animation');
            return;
          }
          
          animationInitialized = true;

        // Get total width of first set (5 logos + gaps)
        let totalWidth = 0;
        for (let i = 0; i < 5; i++) {
          const logo = logos[i] as HTMLElement;
          if (!logo || !logo.offsetWidth) {
            console.warn(`Logo at index ${i} is not available or has no width`);
            // Use a fallback width if element doesn't exist
            totalWidth += 100; // fallback width
          } else {
            totalWidth += logo.offsetWidth;
          }
        }
        
        // If totalWidth is 0, something went wrong, use fallback
        if (totalWidth === 0) {
          totalWidth = 800; // fallback total width
        }

        // Add gap widths (4 gaps between 5 logos, each 64px on desktop, 80px on md)
        const gapWidth = window.innerWidth >= 768 ? 80 : 64;
        totalWidth += gapWidth * 4;

        // Set initial position
        gsap.set(marqueeTrack, { x: 0 });

        // Animation state
        let currentX = 0;
        let isPaused = false;
        // Adjust speed based on device for optimal viewing
        const speed = window.innerWidth >= 768 ? 0.5 : 0.3; // Slower on mobile for better visibility
        
        // Use GSAP ticker for smooth continuous animation
        const animation = gsap.ticker.add(() => {
          if (!isPaused) {
            // Move continuously leftward for proper marquee effect (content moves right to left)
            currentX -= speed;
            
            // Seamless loop: when first set exits left, duplicate set enters from right
            if (currentX <= -totalWidth) {
              currentX += totalWidth; // Add instead of reset for seamless transition
            }
            
            // Apply transform (negative X moves content leftward for seamless marquee)
            gsap.set(marqueeTrack, { x: currentX });
          }
        });

        // Pause on hover (desktop only)
        if (window.innerWidth >= 768) {
          marqueeWrapper.addEventListener('mouseenter', () => {
            isPaused = true;
          });

          // Resume on mouse leave
          marqueeWrapper.addEventListener('mouseleave', () => {
            isPaused = false;
          });
        }
        
        // Pause on touch (mobile) - pause when user touches the marquee
        let touchTimeout: NodeJS.Timeout | null = null;
        marqueeWrapper.addEventListener('touchstart', () => {
          isPaused = true;
          if (touchTimeout) clearTimeout(touchTimeout);
        });
        
        marqueeWrapper.addEventListener('touchend', () => {
          // Resume after a short delay
          touchTimeout = setTimeout(() => {
            isPaused = false;
          }, 500);
        });

        // Store reference for potential cleanup
        (marqueeWrapper as any).__marqueeAnimation = animation;
        };

        // Initialize after all images load
        if (images.length === 0) {
          // No images, initialize immediately
          initAnimation();
        } else {
          images.forEach((img) => {
            if (img.complete && img.naturalWidth > 0) {
              loadedCount++;
              if (loadedCount === images.length && !animationInitialized) {
                initAnimation();
              }
            } else {
              img.addEventListener('load', () => {
                loadedCount++;
                if (loadedCount === images.length && !animationInitialized) {
                  initAnimation();
                }
              });
              // Handle error case
              img.addEventListener('error', () => {
                loadedCount++;
                if (loadedCount === images.length && !animationInitialized) {
                  initAnimation();
                }
              });
            }
          });

          // Fallback: init after 1 second if images don't load
          setTimeout(() => {
            if (!animationInitialized) {
              initAnimation();
            }
          }, 1000);
        }
      } else {
          // Fallback for reduced motion: show static logos
          const marqueeTrack = document.querySelector('[data-marquee-track]') as HTMLElement;
          if (marqueeTrack) {
            marqueeTrack.style.transform = 'translateX(0)';
          }
        }
      };

      // Initialize when DOM is ready
      // Add a small delay to ensure Astro hydration is complete
      const initializeWithDelay = () => {
        // Use requestAnimationFrame to ensure DOM is fully rendered
        requestAnimationFrame(() => {
          setTimeout(initMarquee, 100);
        });
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeWithDelay);
      } else {
        // DOM is already ready, but wait a bit for Astro hydration
        initializeWithDelay();
      }
    }
</script>

<style>
  /* Marquee wrapper */
  .marquee-wrapper {
    max-width: 100%;
    overflow: hidden;
  }

  /* Smooth transforms */
  .marquee-track {
    will-change: transform;
    white-space: nowrap; /* Prevent wrapping during animation */
  }

  /* Logo items */
  .logo-item {
    user-select: none;
    -webkit-user-select: none;
  }

  /* Ensure images are crisp */
  .logo-item img {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }

  /* Ensure marquee works on all devices */
  @media (max-width: 768px) {
    .marquee-wrapper {
      overflow: hidden; /* Keep hidden on mobile for auto-scroll */
      -webkit-overflow-scrolling: touch;
    }
    
    .marquee-track {
      white-space: nowrap; /* Prevent wrapping on mobile */
    }
  }
</style>
