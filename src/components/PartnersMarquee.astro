---
// PartnersMarquee.astro
// Clean horizontal scrolling partner logos with pause on hover
---

<section class="partners-marquee bg-ivory py-20 md:py-28 overflow-hidden">
  <div class="container mx-auto px-4 md:px-6">
    <!-- Section Header -->
    <div class="text-center mb-12 md:mb-16">
      <p class="text-sm uppercase tracking-widest text-charcoal/60 mb-3 font-inter">
        Our Partners
      </p>
      <h2 class="text-4xl md:text-5xl font-playfair text-charcoal mb-4">
        Organizations We Collaborate With
      </h2>
      <p class="text-lg text-charcoal/70 font-inter max-w-2xl mx-auto">
        Building meaningful partnerships to enrich cultural education
      </p>
    </div>

    <!-- Marquee Container -->
    <div class="marquee-wrapper relative" data-marquee-wrapper>
      <div class="marquee-track flex items-center gap-16 md:gap-20" data-marquee-track>
        <!-- First Set of Logos -->
        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/GEF-Logo.jpg" 
            alt="GEF partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/Gandharva.png" 
            alt="Gandharva partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/dharmyog.png" 
            alt="Dharmyog partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/PSS-logo.png" 
            alt="PSS partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/reform.png" 
            alt="Reform partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <!-- Duplicate Set for Seamless Loop -->
        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/GEF-Logo.jpg" 
            alt="GEF partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/Gandharva.png" 
            alt="Gandharva partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/dharmyog.png" 
            alt="Dharmyog partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/PSS-logo.png" 
            alt="PSS partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>

        <div class="logo-item flex-shrink-0 transition-all duration-300 hover:opacity-100 hover:scale-105">
          <img 
            src="/images/reform.png" 
            alt="Reform partner logo"
            class="h-16 md:h-20 w-auto object-contain opacity-70"
          />
        </div>
      </div>
    </div>

  </div>
</section>

<script>
  // #region agent log
  fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:112',message:'Script started',data:{windowDefined:typeof window!=='undefined',readyState:typeof document!=='undefined'?document.readyState:'N/A'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'5,6'})}).catch(()=>{});
  // #endregion
  import { gsap } from 'gsap';

  // Wait for DOM to be ready
  if (typeof window !== 'undefined') {
    // #region agent log
    fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:115',message:'GSAP import check',data:{gsapAvailable:typeof gsap!=='undefined',gsapSet:typeof gsap?.set==='function',gsapTicker:typeof gsap?.ticker==='object'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'2'})}).catch(()=>{});
    // #endregion
    const initMarquee = (isRetry = false) => {
      // #region agent log
      fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:117',message:'initMarquee called',data:{isRetry,readyState:document.readyState},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'5'})}).catch(()=>{});
      // #endregion
      // Check for reduced motion preference
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      // #region agent log
      fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:119',message:'Reduced motion check',data:{prefersReducedMotion},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'4'})}).catch(()=>{});
      // #endregion

      if (!prefersReducedMotion) {
        const marqueeWrapper = document.querySelector('[data-marquee-wrapper]') as HTMLElement;
        const marqueeTrack = marqueeWrapper?.querySelector('[data-marquee-track]') as HTMLElement;
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:122',message:'QuerySelector results',data:{wrapperFound:!!marqueeWrapper,trackFound:!!marqueeTrack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'1'})}).catch(()=>{});
        // #endregion

        if (!marqueeWrapper || !marqueeTrack) {
          // #region agent log
          fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:125',message:'Early return - elements not found',data:{wrapperFound:!!marqueeWrapper,trackFound:!!marqueeTrack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'1'})}).catch(()=>{});
          // #endregion
          return;
        }

        // Calculate the width of one complete set of logos (5 logos)
        const logos = marqueeTrack.querySelectorAll('.logo-item');
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:147',message:'Logo query results - POST-FIX',data:{logoCount:logos.length,isRetry,firstLogoClass:logos[0]?.className||'none',trackChildrenCount:marqueeTrack.children.length},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'6'})}).catch(()=>{});
        // #endregion
        
        if (logos.length === 0) {
          // Only warn and retry once if this is the first attempt
          if (!isRetry) {
            // Retry after a short delay to allow Astro hydration to complete
            setTimeout(() => {
              initMarquee(true);
            }, 300);
          } else if (import.meta.env.DEV) {
            console.warn('No logo items found in marquee track. Marquee animation disabled.');
          }
          // #region agent log
          fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:142',message:'No logos found - returning',data:{logoCount:logos.length,isRetry},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'6'})}).catch(()=>{});
          // #endregion
          return;
        }
        
        // Wait for images to load to get accurate width
        const images = marqueeTrack.querySelectorAll('img');
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:145',message:'Images found',data:{imageCount:images.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'3'})}).catch(()=>{});
        // #endregion
        let loadedCount = 0;
        let animationInitialized = false;
        
        const initAnimation = () => {
          // #region agent log
          fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:150',message:'initAnimation called',data:{animationInitialized,logoCount:logos.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'3,7'})}).catch(()=>{});
          // #endregion
          // Prevent multiple initializations
          if (animationInitialized) return;
          
          // Verify we have at least 5 logos (one complete set)
          if (logos.length < 5) {
            console.warn('Not enough logo items found for marquee animation');
            return;
          }
          
          animationInitialized = true;

        // Calculate total width of first set by measuring where duplicate set starts
        // The 6th logo (index 5) is the start of the duplicate set
        const firstLogo = logos[0] as HTMLElement;
        const duplicateStartLogo = logos[5] as HTMLElement; // 6th logo = duplicate of 1st
        
        let totalWidth = 0;
        if (firstLogo && duplicateStartLogo && firstLogo.offsetWidth && duplicateStartLogo.offsetWidth) {
          // Get actual computed positions relative to track
          const firstRect = firstLogo.getBoundingClientRect();
          const duplicateRect = duplicateStartLogo.getBoundingClientRect();
          const trackRect = marqueeTrack.getBoundingClientRect();
          
          // Distance from first logo's left to duplicate logo's left = one complete set width
          // Use Math.round to avoid subpixel precision issues that can cause visible jumps
          const firstLeft = firstRect.left - trackRect.left;
          const duplicateLeft = duplicateRect.left - trackRect.left;
          totalWidth = Math.round((duplicateLeft - firstLeft) * 100) / 100; // Round to 2 decimal places for stability
          
          // #region agent log
          fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:198',message:'Width calculation by position',data:{totalWidth,firstLeft,duplicateLeft,windowWidth:window.innerWidth},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'7'})}).catch(()=>{});
          // #endregion
          
          // If calculation failed or seems wrong, fall back to sum method
          if (totalWidth <= 0 || !isFinite(totalWidth) || totalWidth < firstLogo.offsetWidth) {
            // Sum logo widths
            for (let i = 0; i < 5; i++) {
              const logo = logos[i] as HTMLElement;
              if (logo?.offsetWidth) {
                totalWidth += logo.offsetWidth;
              }
            }
            // Add gap widths (4 gaps between 5 logos)
            const computedStyle = window.getComputedStyle(marqueeTrack);
            const gap = parseFloat(computedStyle.gap) || (window.innerWidth >= 768 ? 80 : 64);
            totalWidth += gap * 4;
          }
        } else {
          // Fallback: sum logo widths and add gaps
          for (let i = 0; i < 5; i++) {
            const logo = logos[i] as HTMLElement;
            if (logo?.offsetWidth) {
              totalWidth += logo.offsetWidth;
            }
          }
          // Add gap widths (4 gaps between 5 logos)
          const computedStyle = window.getComputedStyle(marqueeTrack);
          const gap = parseFloat(computedStyle.gap) || (window.innerWidth >= 768 ? 80 : 64);
          totalWidth += gap * 4;
        }
        
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:233',message:'Final width calculation',data:{totalWidth},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'7'})}).catch(()=>{});
        // #endregion
        
        // If totalWidth is still 0, something went wrong, use fallback
        if (totalWidth <= 0) {
          totalWidth = 800; // fallback total width
        }

        // Set initial position
        gsap.set(marqueeTrack, { x: 0 });
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:184',message:'GSAP set initial position',data:{success:true},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'2'})}).catch(()=>{});
        // #endregion

        // Animation state
        let currentX = 0;
        let isPaused = false;
        // Adjust speed based on device for optimal viewing
        const speed = window.innerWidth >= 768 ? 0.5 : 0.3; // Slower on mobile for better visibility
        
        // Use GSAP ticker for smooth continuous animation
        const animation = gsap.ticker.add(() => {
          if (!isPaused) {
            // Move continuously leftward for proper marquee effect (content moves right to left)
            currentX -= speed;
            
            // Seamless infinite loop: wrap when we've scrolled one full set width
            // This creates continuous infinite scroll where duplicate seamlessly continues from first
            // The key is to wrap smoothly without any visible jump
            if (currentX <= -totalWidth) {
              // Store old value before wrap
              const beforeWrap = currentX;
              
              // Wrap back seamlessly - add totalWidth to bring it back into range
              // The duplicate set at position 0 now appears where first set started
              currentX = currentX + totalWidth;
              
              // Handle edge case where speed might exceed totalWidth in one frame
              // This shouldn't happen with normal speeds, but ensures stability
              while (currentX <= -totalWidth) {
                currentX += totalWidth;
              }
              
              // Log wrap for debugging (every 100 frames to avoid spam)
              if (Math.random() < 0.01) { // 1% chance per frame
                fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:275',message:'Wrap executed',data:{beforeWrap,afterWrap:currentX,totalWidth,diff:currentX-beforeWrap},timestamp:Date.now(),sessionId:'debug-session',runId:'wrap-debug',hypothesisId:'7'})}).catch(()=>{});
              }
            }
            
            // Apply transform (negative X moves content leftward for seamless marquee)
            gsap.set(marqueeTrack, { x: currentX });
          }
        });
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:206',message:'Animation ticker added',data:{speed,totalWidth,animationCreated:!!animation},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'2,7'})}).catch(()=>{});
        // #endregion

        // Pause on hover (desktop only)
        if (window.innerWidth >= 768) {
          marqueeWrapper.addEventListener('mouseenter', () => {
            isPaused = true;
          });

          // Resume on mouse leave
          marqueeWrapper.addEventListener('mouseleave', () => {
            isPaused = false;
          });
        }
        
        // Pause on touch (mobile) - pause when user touches the marquee
        let touchTimeout: NodeJS.Timeout | null = null;
        marqueeWrapper.addEventListener('touchstart', () => {
          isPaused = true;
          if (touchTimeout) clearTimeout(touchTimeout);
        });
        
        marqueeWrapper.addEventListener('touchend', () => {
          // Resume after a short delay
          touchTimeout = setTimeout(() => {
            isPaused = false;
          }, 500);
        });

        // Store reference for potential cleanup
        (marqueeWrapper as any).__marqueeAnimation = animation;
        };

        // Initialize after all images load
        if (images.length === 0) {
          // No images, initialize immediately
          // #region agent log
          fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:240',message:'No images - initializing immediately',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'3'})}).catch(()=>{});
          // #endregion
          initAnimation();
        } else {
          images.forEach((img, idx) => {
            if (img.complete && img.naturalWidth > 0) {
              loadedCount++;
              // #region agent log
              fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:245',message:'Image already loaded',data:{index:idx,loadedCount,imageCount:images.length,src:img.src},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'3'})}).catch(()=>{});
              // #endregion
              if (loadedCount === images.length && !animationInitialized) {
                initAnimation();
              }
            } else {
              img.addEventListener('load', () => {
                loadedCount++;
                // #region agent log
                fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:252',message:'Image load event',data:{index:idx,loadedCount,imageCount:images.length,src:img.src},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'3'})}).catch(()=>{});
                // #endregion
                if (loadedCount === images.length && !animationInitialized) {
                  initAnimation();
                }
              });
              // Handle error case
              img.addEventListener('error', () => {
                loadedCount++;
                // #region agent log
                fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:259',message:'Image error event',data:{index:idx,loadedCount,imageCount:images.length,src:img.src},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'3'})}).catch(()=>{});
                // #endregion
                if (loadedCount === images.length && !animationInitialized) {
                  initAnimation();
                }
              });
            }
          });

          // Fallback: init after 1 second if images don't load
          setTimeout(() => {
            if (!animationInitialized) {
              // #region agent log
              fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:270',message:'Fallback timeout - initializing',data:{loadedCount,imageCount:images.length,animationInitialized},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'3'})}).catch(()=>{});
              // #endregion
              initAnimation();
            }
          }, 1000);
        }
      } else {
          // Fallback for reduced motion: show static logos
          const marqueeWrapper = document.querySelector('[data-marquee-wrapper]') as HTMLElement;
          const marqueeTrack = marqueeWrapper?.querySelector('[data-marquee-track]') as HTMLElement;
          if (marqueeTrack) {
            marqueeTrack.style.transform = 'translateX(0)';
          }
        }
      };

      // Initialize when DOM is ready
      // Add a small delay to ensure Astro hydration is complete
      const initializeWithDelay = () => {
        // Use requestAnimationFrame to ensure DOM is fully rendered
        requestAnimationFrame(() => {
          // #region agent log
          fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:287',message:'RAF callback - calling initMarquee',data:{readyState:document.readyState},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'5'})}).catch(()=>{});
          // #endregion
          setTimeout(initMarquee, 100);
        });
      };

      if (document.readyState === 'loading') {
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:292',message:'Document loading - waiting for DOMContentLoaded',data:{readyState:document.readyState},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'5'})}).catch(()=>{});
        // #endregion
        document.addEventListener('DOMContentLoaded', initializeWithDelay);
      } else {
        // DOM is already ready, but wait a bit for Astro hydration
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/8bd62af5-42d0-4dea-96c6-a6b4c977dfa9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PartnersMarquee.astro:296',message:'Document ready - calling initializeWithDelay',data:{readyState:document.readyState},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'5'})}).catch(()=>{});
        // #endregion
        initializeWithDelay();
      }
    }
</script>

<style>
  /* Marquee wrapper */
  .marquee-wrapper {
    max-width: 100%;
    overflow: hidden;
  }

  /* Smooth transforms */
  .marquee-track {
    will-change: transform;
    white-space: nowrap; /* Prevent wrapping during animation */
  }

  /* Logo items */
  .logo-item {
    user-select: none;
    -webkit-user-select: none;
  }

  /* Ensure images are crisp */
  .logo-item img {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }

  /* Ensure marquee works on all devices */
  @media (max-width: 768px) {
    .marquee-wrapper {
      overflow: hidden; /* Keep hidden on mobile for auto-scroll */
      -webkit-overflow-scrolling: touch;
    }
    
    .marquee-track {
      white-space: nowrap; /* Prevent wrapping on mobile */
    }
  }
</style>
